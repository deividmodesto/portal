{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório de Divergências - {{ data_inicio|date:"d/m/Y" }} a {{ data_fim|date:"d/m/Y" }}</title>
    <style>
        body { font-family: sans-serif; margin: 20px; color: #333; }
        .report-header { text-align: center; border-bottom: 2px solid #ccc; padding-bottom: 15px; margin-bottom: 30px; }
        .report-header img { max-height: 60px; margin-bottom: 10px; }
        h1 { font-weight: normal; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #e9ecef; }
        td.numero { text-align: right; }
        .divergencia-falta { font-weight: bold; color: #d9534f; } /* Vermelho para falta */
        .divergencia-excesso { font-weight: bold; color: #5cb85c; } /* Verde para excesso */
        .observacao { font-style: italic; color: #555; font-size: 0.9em; }
        @media print {
            .no-print { display: none; }
        }
        .print-button { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <button onclick="window.print();" class="print-button no-print">Imprimir</button>

    <div class="report-header">
        <img src="{% static 'img/logo_reunidas2.png' %}" alt="Logo Reunidas">
        <h1>Relatório de Divergências na Coleta</h1>
        <p>Período de Coleta: de <strong>{{ data_inicio|date:"d/m/Y" }}</strong> até <strong>{{ data_fim|date:"d/m/Y" }}</strong></p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Data Coleta</th>
                <th>Fornecedor</th>
                <th>Pedido</th>
                <th>Produto</th>
                <th class="numero">Qtd. Declarada</th>
                <th class="numero">Qtd. Coletada</th>
                <th class="numero">Diferença</th>
                <th>Observação da Divergência</th>
            </tr>
        </thead>
        <tbody>
            {% for detalhe in detalhes %}
            <tr>
                <td>{{ detalhe.item_coleta.data_agendada|date:"d/m/Y" }}</td>
                <td>{{ detalhe.item_coleta.pedido_liberado.fornecedor_usuario.nome_fornecedor }}</td>
                <td>{{ detalhe.item_coleta.pedido_liberado.numero_pedido }}</td>
                <td>{{ detalhe.item_erp.c7_produto }} - {{ detalhe.item_erp.c7_descri }}</td>
                <td class="numero">{{ detalhe.quantidade_disponivel|localize }}</td>
                <td class="numero">{{ detalhe.quantidade_coletada|localize }}</td>
                
                {% comment %} CORREÇÃO: Remove o filtro |abs e usa a variável 'diferenca_abs' da view {% endcomment %}
                {% if detalhe.diferenca > 0 %}
                    <td class="numero divergencia-falta">-{{ detalhe.diferenca|localize }}</td>
                {% else %}
                    <td class="numero divergencia-excesso">+{{ detalhe.diferenca_abs|localize }}</td>
                {% endif %}

                <td class="observacao">{{ detalhe.observacao_divergencia|default:"Nenhuma." }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 2em;">Nenhuma divergência encontrada para o período selecionado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>