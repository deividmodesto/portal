{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pedido de Compra Nº {{ info_geral.c7_num }}</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        body { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 9pt; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #012E23; padding-bottom: 10px; margin-bottom: 20px; }
        .header img { max-height: 60px; }
        .header .empresa-info { text-align: right; }
        .header .empresa-info h2 { margin: 0; color: #012E23; }
        h1 { text-align: center; font-size: 16pt; margin-bottom: 5px; }
        .aprovacao-info { text-align: center; font-size: 8pt; margin-bottom: 20px; color: #555; }
        .aprovacao-info strong { color: #000; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .info-box { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; }
        .info-box h3 { margin-top: 0; font-size: 11pt; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .info-box p { margin: 4px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
        th { background-color: #e9ecef; font-weight: bold; }
        td.numero { text-align: right; }
        .obs-item { font-size: 8pt; color: #555; }
        .footer { margin-top: 30px; }
        .totais { float: right; width: 45%; }
        .totais td { border: none; padding: 4px 8px; }
        .totais .total-geral { font-weight: bold; border-top: 1px solid #333; }
        .status-badge { font-weight: bold; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; }
        .status-Bloqueado { background-color: #dc3545; }
        .status-Liberado { background-color: #05B540; }
        .status-Reprovado { background-color: #ffc107; color: #333; }
        .status-Nao-Definido { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="header">
        {% if logo_base64 %}<img src="{{ logo_base64 }}" alt="Logo Reunidas">{% endif %}
        <div class="empresa-info">
            <h1>Grupo Reunidas</h1>
            {% if empresa_emitente %}
                <h2>(Filial: {{ empresa_emitente.m0_filial }})</h2>
                <p>
                    {{ empresa_emitente.m0_endent }}, {{ empresa_emitente.m0_bairent }}<br>
                    {{ empresa_emitente.m0_cident }} - CEP {{ empresa_emitente.m0_cepent }}<br>
                    CNPJ: {{ empresa_emitente.m0_cgc }} | IE: {{ empresa_emitente.m0_insc }}<br>
                    Telefone: {{ empresa_emitente.m0_tel }}
                </p>
            {% else %}
                <p>Informações da empresa não encontradas para esta filial.</p>
            {% endif %}
        </div>
    </div>
    <h1>Pedido de Compra Nº {{ info_geral.c7_num }}</h1>

    {% if aprovacoes %}
        <div class="aprovacao-info">
            <p><strong>Status de Aprovação:</strong>
            {% for aprovacao in aprovacoes %}
                <small><strong>{{ aprovacao.aprovador }}:</strong> {{ aprovacao.status }}</small>{% if not forloop.last %}, {% endif %}
            {% endfor %}
            </p>
        </div>
    {% endif %}

    <div class="info-grid">
        <div class="info-box">
            <h3>FORNECEDOR</h3>
            {% if fornecedor %}
            <p><strong>Nome:</strong> {{ fornecedor.a2_nome }}</p>
            <p><strong>CNPJ:</strong> {{ fornecedor.a2_cgc }}</p>
            <p><strong>Endereço:</strong> {{ fornecedor.a2_end }}, {{ fornecedor.a2_bairro }} - {{ fornecedor.a2_mun }} / {{ fornecedor.a2_est }}</p>
            <p><strong>Contato:</strong> {{ fornecedor.a2_tel }}</p>
            {% else %}
            <p><strong>Informações do fornecedor não encontradas no ERP.</strong></p>
            {% endif %}
        </div>
        <div class="info-box">
            <h3>DADOS DO PEDIDO</h3>
            <p><strong>Data de Emissão:</strong> {{ info_geral.data_emissao_formatada }}</p>
            <p><strong>Data de Necessidade:</strong> {{ data_necessidade }}</p>
            <p><strong>Cond. Pagamento:</strong> {{ desc_cond_pagamento }}</p>
            <p><strong>Transportadora:</strong> {{ info_geral.c7_transp|default_if_none:"N/A" }}</p>
            <p><strong>Status do Pedido:</strong> <span class="status-badge status-{{ status_class }}">{{ status_pedido }}</span></p>
        </div>
    </div>
    
    {% if obs_solicitacao_compra != "N/A" %}
    <div class="info-box" style="margin-bottom: 25px;">
        <h3>OBSERVAÇÃO DA SOLICITAÇÃO DE COMPRA</h3>
        <p>{{ obs_solicitacao_compra }}</p>
    </div>
    {% endif %}

    <h3>ITENS DO PEDIDO</h3>
    <table>
        <thead>
            <tr>
                <th>Item</th>
                <th>Produto</th>
                <th>Descrição</th>
                <th class="numero">Qtd.</th>
                <th>UN</th>
                <th>Entrega</th>
                <th class="numero">Preço Unit.</th>
                <th class="numero">Valor Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in itens_pedido %}
            <tr>
                <td>{{ item.c7_item }}</td>
                <td>{{ item.c7_produto }}</td>
                <td>
                    {{ item.c7_descri }}
                    {% if item.c7_obs %}<div class="obs-item"><strong>Obs:</strong> {{ item.c7_obs }}</div>{% endif %}
                </td>
                <td class="numero">{{ item.c7_quant|localize }}</td>
                <td>{{ item.c7_um }}</td> <td>{{ item.data_entrega_formatada }}</td>
                <td class="numero">R$ {{ item.c7_preco|localize }}</td>
                <td class="numero">R$ {{ item.c7_total|localize }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="footer">
        <div class="totais">
            <table>
                <tr><td>Subtotal Produtos:</td><td class="numero">R$ {{ totais.produtos|localize }}</td></tr>
                <tr><td>Descontos:</td><td class="numero">R$ {{ totais.desconto|localize }}</td></tr>
                <tr><td>Valor Frete:</td><td class="numero">R$ {{ totais.frete|localize }}</td></tr>
                <tr><td>Valor IPI:</td><td class="numero">R$ {{ totais.ipi|localize }}</td></tr>
                <tr class="total-geral"><td>VALOR TOTAL:</td><td class="numero">R$ {{ totais.geral|localize }}</td></tr>
            </table>
        </div>
        </div>
</body>
</html>